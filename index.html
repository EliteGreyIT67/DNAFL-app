<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNA Florida App - Do Not Adopt Lists</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { animation: { 'fade-in': 'fadeIn 0.5s ease-in' } } }
        }
    </script>
    <style>
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fade-in 0.5s ease-in; }
        th { position: sticky; top: 0; z-index: 10; }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen p-4">
    <!-- Dark Mode Toggle -->
    <div class="flex justify-end mb-4">
        <button id="darkToggle" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600" aria-label="Toggle dark mode">
            ðŸŒ™ Dark Mode
        </button>
    </div>

    <!-- Tabs Navigation -->
    <div id="tabsNav" class="flex flex-wrap border-b border-gray-200 dark:border-gray-700 mb-4 overflow-x-auto">
        <!-- Tabs generated by JS -->
    </div>

    <!-- Filters Row -->
    <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-4">
        <!-- Global Search -->
        <input type="text" id="globalSearch" placeholder="Search all columns..." class="p-2 border border-gray-300 dark:border-gray-600 rounded dark:bg-gray-800" aria-label="Global search">

        <!-- County Filter -->
        <select id="countyFilter" class="p-2 border border-gray-300 dark:border-gray-600 rounded dark:bg-gray-800" aria-label="Filter by county">
            <option value="">All Counties</option>
            <!-- Options populated by JS -->
        </select>

        <!-- Date Range -->
        <div class="flex gap-2">
            <input type="date" id="dateFrom" class="p-2 border border-gray-300 dark:border-gray-600 rounded dark:bg-gray-800 flex-1" aria-label="From date">
            <input type="date" id="dateTo" class="p-2 border border-gray-300 dark:border-gray-600 rounded dark:bg-gray-800 flex-1" aria-label="To date">
        </div>

        <!-- Sort Select -->
        <select id="sortSelect" class="p-2 border border-gray-300 dark:border-gray-600 rounded dark:bg-gray-800" aria-label="Sort by column">
            <option value="name-asc">Name (A-Z)</option>
            <option value="date-desc">Date (Newest)</option>
            <option value="date-asc">Date (Oldest)</option>
        </select>
    </div>

    <!-- Export Button -->
    <div class="mb-4">
        <button id="exportBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" aria-label="Export filtered data to CSV">
            ðŸ“Š Export CSV
        </button>
    </div>

    <!-- Data Table -->
    <div class="overflow-x-auto shadow-md rounded-lg">
        <table id="dataTable" class="w-full table-auto border-collapse border border-gray-300 dark:border-gray-600">
            <thead class="bg-gray-50 dark:bg-gray-800">
                <tr>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left">Name</th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left">County</th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left">Date</th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left">Details</th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left">Link</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
                <!-- Rows generated by JS -->
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="flex justify-center mt-4 space-x-2">
        <!-- Generated by JS -->
    </div>

    <!-- Loading/Error Messages -->
    <div id="loading" class="text-center py-4 hidden">Loading data...</div>
    <div id="error" class="text-red-500 text-center py-4 hidden"></div>

    <script>
        // === CONFIG ===
        const SHEET_ID = '1V0ERkUXzc2G_SvSVUaVac50KyNOpw4N7bL6yAiZospY';  // Your master Google Sheet ID
        const PAGE_SIZE = 50;  // Rows per page
        const BASE_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=`;

        const tables = {
            dna: {
                url: `${BASE_URL}DNA%20List`,
                label: 'DNA List'
            },
            bcac: {
                url: `${BASE_URL}BCAC%20DNA%20List`,
                label: 'BCAC DNA List'
            },
            // New tabs from scraped sources
            leeEnjoined: {
                url: `${BASE_URL}Lee%20Enjoined`,
                label: 'Lee Enjoined'
            },
            collier: {
                url: `${BASE_URL}Collier%20Registry`,
                label: 'Collier Registry'
            },
            brevard: {
                url: `${BASE_URL}Brevard%20Registry`,
                label: 'Brevard Registry'
            },
            hillsboroughEnjoined: {
                url: `${BASE_URL}Hillsborough%20Enjoined`,
                label: 'Hillsborough Enjoined'
            },
            volusia: {
                url: `${BASE_URL}Volusia%20Abuse`,
                label: 'Volusia Abuse'
            },
            marionRegistry: {
                url: `${BASE_URL}Marion%20Registry`,
                label: 'Marion Registry'
            },
            miamiDade: {
                url: `${BASE_URL}Miami-Dade%20Cruelty`,
                label: 'Miami-Dade Cruelty'
            },
            // Additional from full scraper
            hillsboroughRegistry: {
                url: `${BASE_URL}Hillsborough%20Registry`,
                label: 'Hillsborough Registry'
            },
            marionEnjoined: {
                url: `${BASE_URL}Marion%20Enjoined`,
                label: 'Marion Enjoined'
            },
            seminole: {
                url: `${BASE_URL}Seminole%20PDF`,
                label: 'Seminole PDF'
            },
            pasco: {
                url: `${BASE_URL}Pasco%20Registry`,
                label: 'Pasco Registry'
            },
            leeSearch: {
                url: `${BASE_URL}Lee%20Search`,
                label: 'Lee Search'
            }
            // Note: Leon skipped as empty; add if data added: leon: { url: `${BASE_URL}Leon%20Abuse`, label: 'Leon Abuse' }
        };

        // Global state
        let currentData = [];
        let filteredData = [];
        let currentPage = 1;
        let currentTab = 'dna';  // Default tab
        let counties = new Set();  // For filter options

        // Dark mode toggle
        const darkToggle = document.getElementById('darkToggle');
        const html = document.documentElement;
        const isDark = localStorage.getItem('darkMode') === 'true';
        if (isDark) html.classList.add('dark');
        darkToggle.textContent = isDark ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
        darkToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            const newIsDark = html.classList.contains('dark');
            localStorage.setItem('darkMode', newIsDark);
            darkToggle.textContent = newIsDark ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
        });

        // === UTILS ===
        function fetchCSV(url) {
            return fetch(url)
                .then(res => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    return res.text();
                })
                .then(csv => {
                    const lines = csv.split('\n').filter(line => line.trim());
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    const rows = lines.slice(1).map(line => {
                        const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                        const obj = {};
                        headers.forEach((header, i) => obj[header] = values[i] || '');
                        return obj;
                    }).filter(row => row.Name && row.Name.trim());  // Skip empty
                    return rows;
                })
                .catch(err => {
                    showError(`Failed to load ${url}: ${err.message}`);
                    return [];
                });
        }

        function parseDate(dateStr) {
            // Handle formats: YYYY-MM-DD, MM/DD/YYYY, MM-YY, etc.
            const parts = dateStr.match(/(\d{1,2})[/-](\d{1,2})[/-]?(\d{4})?/);
            if (parts) {
                const [_, m, d, y] = parts;
                return new Date(y ? `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}` : `${new Date().getFullYear()}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`);
            }
            return new Date(dateStr) || new Date(NaN);
        }

        function showLoading(show = true) {
            document.getElementById('loading').classList.toggle('hidden', !show);
            document.getElementById('dataTable').classList.toggle('hidden', show);
            document.getElementById('pagination').classList.toggle('hidden', show);
        }

        function showError(msg) {
            const el = document.getElementById('error');
            el.textContent = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        // === RENDERING ===
        function renderTabs() {
            const nav = document.getElementById('tabsNav');
            nav.innerHTML = Object.entries(tables).map(([key, { label }], i) => 
                `<button class="tab-btn px-4 py-2 ${key === currentTab ? 'border-b-2 border-blue-500' : ''} hover:text-blue-500" data-tab="${key}" aria-label="Switch to ${label} tab">${label}</button>`
            ).join('');
        }

        function renderCountyFilter() {
            const select = document.getElementById('countyFilter');
            select.innerHTML = '<option value="">All Counties</option>' + 
                Array.from(counties).sort().map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function renderTable(data = filteredData) {
            const tbody = document.getElementById('tableBody');
            const start = (currentPage - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pageData = data.slice(start, end);

            tbody.innerHTML = pageData.map(row => `
                <tr class="fade-in hover:bg-gray-50 dark:hover:bg-gray-800">
                    <td class="border px-4 py-2">${row.Name || ''}</td>
                    <td class="border px-4 py-2">${row.County || ''}</td>
                    <td class="border px-4 py-2">${row.Date || ''}</td>
                    <td class="border px-4 py-2 max-w-xs truncate" title="${row.Details}">${row.Details || ''}</td>
                    <td class="border px-4 py-2"><a href="${row.Link || '#'}" target="_blank" class="text-blue-500 hover:underline">${row.Link ? 'View' : 'N/A'}</a></td>
                </tr>
            `).join('');

            renderPagination(data.length);
        }

        function renderPagination(total) {
            const totalPages = Math.ceil(total / PAGE_SIZE);
            const pag = document.getElementById('pagination');
            if (totalPages <= 1) {
                pag.innerHTML = '';
                return;
            }
            pag.innerHTML = `
                <button class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded ${currentPage === 1 ? 'invisible' : ''}" onclick="changePage(${currentPage - 1})" aria-label="Previous page">â€¹</button>
                ${Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                    const p = currentPage > 3 ? currentPage - 2 + i : i + 1;
                    return `<button class="px-3 py-1 ${p === currentPage ? 'bg-blue-500 text-white' : 'bg-gray-200 dark:bg-gray-700'} rounded" onclick="changePage(${p})" aria-label="Page ${p}">${p}</button>`;
                }).join('')}
                <button class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded ${currentPage === totalPages ? 'invisible' : ''}" onclick="changePage(${currentPage + 1})" aria-label="Next page">â€º</button>
            `;
        }

        // === FILTERING & SORTING ===
        function applyFiltersAndSort() {
            let data = [...currentData];
            const search = document.getElementById('globalSearch').value.toLowerCase();
            const county = document.getElementById('countyFilter').value;
            const dateFrom = document.getElementById('dateFrom').value ? new Date(document.getElementById('dateFrom').value) : new Date(0);
            const dateTo = document.getElementById('dateTo').value ? new Date(document.getElementById('dateTo').value) : new Date();
            const [sortCol, sortDir] = document.getElementById('sortSelect').value.split('-');

            // Search
            if (search) {
                data = data.filter(row => 
                    Object.values(row).some(val => val.toString().toLowerCase().includes(search))
                );
            }

            // County
            if (county) data = data.filter(row => row.County === county);

            // Date range
            data = data.filter(row => {
                const rowDate = parseDate(row.Date);
                return !isNaN(rowDate) && rowDate >= dateFrom && rowDate <= dateTo;
            });

            // Sort
            data.sort((a, b) => {
                let aVal = sortCol === 'name' ? a.Name : parseDate(a.Date);
                let bVal = sortCol === 'name' ? b.Name : parseDate(b.Date);
                if (sortCol !== 'name') {
                    aVal = isNaN(aVal) ? new Date(0) : aVal;
                    bVal = isNaN(bVal) ? new Date(0) : bVal;
                }
                return (aVal > bVal ? 1 : -1) * (sortDir === 'asc' ? 1 : -1);
            });

            filteredData = data;
            currentPage = 1;
            renderTable();
        }

        // === EVENTS ===
        function changeTab(tabKey) {
            currentTab = tabKey;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('border-b-2', 'border-blue-500'));
            document.querySelector(`[data-tab="${tabKey}"]`).classList.add('border-b-2', 'border-blue-500');
            loadData(tables[tabKey].url);
        }

        function changePage(page) {
            currentPage = page;
            renderTable();
        }

        function exportCSV() {
            if (filteredData.length === 0) return showError('No data to export');
            const csv = [Object.keys(filteredData[0]).join(',')].concat(
                filteredData.map(row => Object.values(row).map(v => `"${v}"`).join(','))
            ).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `DNAFL-${currentTab}-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Filter/sort listeners (debounced)
        let debounceTimer;
        function debounce(fn, delay) {
            return () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(fn, delay);
            };
        }
        ['globalSearch', 'countyFilter', 'dateFrom', 'dateTo', 'sortSelect'].forEach(id => {
            document.getElementById(id).addEventListener('input', debounce(applyFiltersAndSort, 300));
            if (id !== 'globalSearch') document.getElementById(id).addEventListener('change', applyFiltersAndSort);
        });
        document.getElementById('exportBtn').addEventListener('click', exportCSV);

        // === MAIN LOAD ===
        async function loadData(url) {
            showLoading(true);
            document.getElementById('error').classList.add('hidden');
            currentData = await fetchCSV(url);
            counties.clear();
            currentData.forEach(row => {
                if (row.County && row.County.trim()) counties.add(row.County.trim());
            });
            renderCountyFilter();
            applyFiltersAndSort();
            showLoading(false);
        }

        // Init
        renderTabs();
        document.querySelector('.tab-btn')?.click();  // Load default tab
        document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', (e) => changeTab(e.target.dataset.tab)));
    </script>
</body>
</html>
