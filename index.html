<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dashboard for Florida's Animal Abuser Registries">
    <title>DNAFL Dashboard</title>
 
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        slate: { 850: '#1e293b' } // Custom darker slate for dark mode depth
                    }
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        @layer components {
            .btn-secondary { @apply flex items-center px-3 py-2 rounded-lg text-sm font-medium bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 border border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors; }
            .input-field { @apply w-full px-3 py-2 border border-slate-300 dark:border-slate-700 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white; }
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { @apply bg-slate-300 dark:bg-slate-600 rounded-full hover:bg-slate-400 dark:hover:bg-slate-500; }
    </style>
 
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
 
    <!-- React Dependencies (UMD) - Using cdnjs for better stability -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
 
    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
 
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.0/Recharts.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 font-sans transition-colors duration-200">
    <div id="root"></div>
 
    <script type="text/babel">
        // --- Imports & Aliases for UMD ---
        const { useState, useEffect, useMemo, useRef, Component } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, ResponsiveContainer, LineChart, Line } = Recharts;
 
        // Lucide Icons wrapper for React UMD
        const Icon = ({ name, className, ...props }) => {
            const lucideIcon = lucide.icons[name];
            if (!lucideIcon) return null;
            return <svg {...props}
                className={className}
                xmlns="http://www.w3.org/2000/svg"
                width={props.size || 24} height={props.size || 24}
                viewBox="0 0 24 24" fill="none" stroke="currentColor"
                strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round"
                dangerouslySetInnerHTML={{ __html: lucideIcon.toSvg(props).match(/>(.*)</)[1] }}
            />;
        };
 
        // Pre-define used icons
        const I = {
            Search: (p) => <Icon name="search" {...p} />,
            AlertTriangle: (p) => <Icon name="alert-triangle" {...p} />,
            BarChart3: (p) => <Icon name="bar-chart-3" {...p} />,
            ExternalLink: (p) => <Icon name="external-link" {...p} />,
            Calendar: (p) => <Icon name="calendar" {...p} />,
            MapPin: (p) => <Icon name="map-pin" {...p} />,
            Menu: (p) => <Icon name="menu" {...p} />,
            X: (p) => <Icon name="x" {...p} />,
            ChevronDown: (p) => <Icon name="chevron-down" {...p} />,
            ChevronUp: (p) => <Icon name="chevron-up" {...p} />,
            Link: (p) => <Icon name="link" {...p} />,
            Filter: (p) => <Icon name="filter" {...p} />,
            Download: (p) => <Icon name="download" {...p} />,
            Star: (p) => <Icon name="star" {...p} />,
            ChevronLeft: (p) => <Icon name="chevron-left" {...p} />,
            ChevronRight: (p) => <Icon name="chevron-right" {...p} />,
            TrendingUp: (p) => <Icon name="trending-up" {...p} />,
            Moon: (p) => <Icon name="moon" {...p} />,
            Sun: (p) => <Icon name="sun" {...p} />,
            Copy: (p) => <Icon name="copy" {...p} />,
            Check: (p) => <Icon name="check" {...p} />,
            Trash2: (p) => <Icon name="trash-2" {...p} />
        };
 
        // --- Constants & Config ---
        const SHEET_ID = '1V0ERkUXzc2G_SvSVUaVac50KyNOpw4N7bL6yAiZospY';
        const MASTER_SHEET = 'Master_Registry';
        const REGISTRIES = [
            { id: 'All', label: 'All Registries', color: 'blue' },
            { id: 'Lee Registry', label: 'Lee', color: 'orange' },
            { id: 'Lee Enjoined', label: 'Lee Enjoined', color: 'amber' },
            { id: 'Marion Registry', label: 'Marion', color: 'yellow' },
            { id: 'Marion Enjoined', label: 'Marion Enjoined', color: 'lime' },
            { id: 'Hillsborough Registry', label: 'Hillsborough', color: 'red' },
            { id: 'Hillsborough Enjoined PDF', label: 'Hillsborough Enjoined', color: 'rose' },
            { id: 'Volusia PDF', label: 'Volusia', color: 'indigo' },
            { id: 'Seminole PDF', label: 'Seminole', color: 'violet' },
            { id: 'Pasco Clerk App', label: 'Pasco', color: 'emerald' },
            { id: 'Collier Sheriff', label: 'Collier', color: 'green' },
            { id: 'Osceola Clerk PDF', label: 'Osceola', color: 'teal' },
            { id: 'Broward Registry', label: 'Broward', color: 'pink' },
            { id: 'Tallahassee/Leon Registry', label: 'Leon', color: 'fuchsia' },
            { id: 'Polk Registry', label: 'Polk', color: 'cyan' },
            { id: 'Orange Registry', label: 'Orange', color: 'sky' },
            { id: 'Palm Beach Registry', label: 'Palm Beach', color: 'blue' },
            { id: 'Miami-Dade Registry', label: 'Miami-Dade', color: 'purple' },
            { id: 'Brevard Registry', label: 'Brevard', color: 'indigo' },
            { id: 'Manatee Clerk Animal Cases', label: 'Manatee', color: 'gray' },
            { id: 'Sarasota Vicious Dog Registry', label: 'Sarasota', color: 'slate' },
            { id: 'Charlotte Animal Control', label: 'Charlotte', color: 'zinc' },
        ];
        const ITEMS_PER_PAGE = 25;
 
        // --- Utilities ---
        const generateRecordId = (record) => `${record.Name}-${record.Date}-${record.County}`.replace(/\s+/g, '').toLowerCase();
        const renderCellContent = (content) => {
            if (typeof content === 'string' && (content.startsWith('http://') || content.startsWith('https://'))) {
                return <a href={content} target="_blank" rel="noopener noreferrer" className="text-blue-600 dark:text-blue-400 hover:underline inline-flex items-center" onClick={e => e.stopPropagation()}><I.Link className="w-3 h-3 mr-1" /> Link</a>;
            }
            return content;
        };
        const downloadFile = ({ data, fileName, fileType }) => {
            const blob = new Blob([data], { type: fileType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none'; a.href = url; a.download = fileName;
            document.body.appendChild(a); a.click();
            window.URL.revokeObjectURL(url); document.body.removeChild(a);
        };
        const parseCSVNative = (str) => {
            const arr = []; let quote = false;
            for (let row = 0, col = 0, c = 0; c < str.length; c++) {
                let cc = str[c], nc = str[c+1];
                arr[row] = arr[row] || []; arr[row][col] = arr[row][col] || '';
                if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; }
                else if (cc == '"') { quote = !quote; }
                else if (cc == ',' && !quote) { ++col; }
                else if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; }
                else if (cc == '\n' && !quote) { ++row; col = 0; }
                else { arr[row][col] += cc; }
            }
            return arr;
        };
        const csvToObjects = (csvText) => {
            const rows = parseCSVNative(csvText);
            if (rows.length < 2) return [];
            const headers = rows[0].map(h => h.trim());
            return rows.slice(1).filter(r => r.length > 1).map(row => {
                const entry = {};
                headers.forEach((h, i) => entry[h] = row[i] ? row[i].trim() : 'N/A');
                if (!entry.Name) entry.Name = 'Unknown';
                if (!entry.Date) entry.Date = 'Unknown';
                entry._id = generateRecordId(entry);
                return entry;
            });
        };
 
        // --- Error Boundary ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return <div className="min-h-screen flex items-center justify-center bg-red-50 dark:bg-red-900/20 p-4"><div className="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-xl max-w-md w-full text-center"><I.AlertTriangle className="h-12 w-12 text-red-500 mx-auto mb-4" /><h2 className="text-xl font-bold text-red-700 dark:text-red-400 mb-2">Something went wrong</h2><p className="text-slate-600 dark:text-slate-300 mb-4">The application encountered an unexpected error.</p><button onClick={() => window.location.reload()} className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md transition-colors">Reload Dashboard</button></div></div>;
                }
                return this.props.children;
            }
        }
 
        // --- Sub-Components ---
        const MultiSelect = ({ options, selected, onChange, label }) => {
            const [isOpen, setIsOpen] = useState(false);
            const containerRef = useRef(null);
            useEffect(() => {
                const handleClickOutside = (event) => { if (containerRef.current && !containerRef.current.contains(event.target)) setIsOpen(false); };
                document.addEventListener("mousedown", handleClickOutside); return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);
            const toggleOption = (option) => {
                const newSelected = selected.includes(option) ? selected.filter(s => s !== option) : [...selected, option];
                onChange(newSelected);
            };
            return (
                <div className="relative" ref={containerRef}>
                    <label className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1 block">{label}</label>
                    <button onClick={() => setIsOpen(!isOpen)} className="input-field flex justify-between items-center text-left">
                        <span className="truncate">{selected.length === 0 ? "All Counties" : `${selected.length} selected`}</span>
                        <I.ChevronDown className="w-4 h-4 ml-2 opacity-50" />
                    </button>
                    {isOpen && (
                        <div className="absolute z-10 mt-1 w-full bg-white dark:bg-slate-800 shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm">
                            {options.map(option => (
                                <div key={option} className={`cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-slate-100 dark:hover:bg-slate-700 ${selected.includes(option) ? 'text-blue-600 dark:text-blue-400 font-semibold' : 'text-slate-900 dark:text-slate-200'}`} onClick={() => toggleOption(option)}>
                                    <span className="block truncate">{option}</span>
                                    {selected.includes(option) && <span className="absolute inset-y-0 right-0 flex items-center pr-4 text-blue-600 dark:text-blue-400"><I.Check className="h-4 w-4" /></span>}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };
 
        const CopyButton = ({ text }) => {
            const [copied, setCopied] = useState(false);
            const handleCopy = (e) => {
                e.stopPropagation();
                // Fallback copy method for iframes/sandboxed environments where navigator.clipboard might fail
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    // Avoid scrolling to bottom
                    textArea.style.top = "0";
                    textArea.style.left = "0";
                    textArea.style.position = "fixed";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    if (successful) {
                        setCopied(true);
                        setTimeout(() => setCopied(false), 2000);
                    } else {
                         console.error('Fallback copy failed');
                    }
                } catch (err) {
                    console.error('Copy failed', err);
                }
            };
            return <button onClick={handleCopy} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 p-1 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors" title="Copy row data">{copied ? <I.Check className="w-4 h-4 text-green-500" /> : <I.Copy className="w-4 h-4" />}</button>;
        };
 
        // --- Main App ---
        function App() {
            const [activeTab, setActiveTab] = useState(REGISTRIES[0].id);
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [watchlist, setWatchlist] = useState(() => JSON.parse(localStorage.getItem('dnafl_watchlist') || '{}'));
            const [showWatchlist, setShowWatchlist] = useState(false);
            const [filters, setFilters] = useState({ global: '', name: '', counties: [], dateFrom: '', dateTo: '' });
            const [showFilters, setShowFilters] = useState(false);
            const [sortConfig, setSortConfig] = useState({ key: 'Date', direction: 'descending' });
            const [currentPage, setCurrentPage] = useState(1);
            const [showCharts, setShowCharts] = useState(false);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem('dnafl_theme') === 'dark' || (!('dnafl_theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches));
 
            useEffect(() => {
                document.documentElement.classList.toggle('dark', darkMode);
                localStorage.setItem('dnafl_theme', darkMode ? 'dark' : 'light');
            }, [darkMode]);
 
            useEffect(() => localStorage.setItem('dnafl_watchlist', JSON.stringify(watchlist)), [watchlist]);
            useEffect(() => {
                setLoading(true); setError(null); setCurrentPage(1);
                fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(MASTER_SHEET)}`)
                    .then(res => { if (!res.ok) throw new Error('Failed to fetch'); return res.text(); })
                    .then(txt => {
                        if (txt.includes('<!doctype html>')) throw new Error('Invalid sheet tab or empty data');
                        setData(csvToObjects(txt)); setLoading(false);
                    })
                    .catch(err => { console.error(err); setError(err.message); setLoading(false); });
            }, []);
 
            const filteredData = useMemo(() => {
                let res = showWatchlist ? Object.values(watchlist) : data;
                if (activeTab !== 'All' && !showWatchlist) res = res.filter(i => i.Source === activeTab);
                if (filters.global && !showWatchlist) {
                    const s = filters.global.toLowerCase();
                    res = res.filter(i => Object.values(i).some(v => String(v).toLowerCase().includes(s)));
                }
                if (!showWatchlist) {
                    if (filters.name) res = res.filter(i => i.Name?.toLowerCase().includes(filters.name.toLowerCase()));
                    if (filters.counties.length > 0) res = res.filter(i => filters.counties.includes(i.County));
                    if (filters.dateFrom) res = res.filter(i => new Date(i.Date) >= new Date(filters.dateFrom));
                    if (filters.dateTo) res = res.filter(i => new Date(i.Date) <= new Date(filters.dateTo));
                }
                return res;
            }, [data, watchlist, showWatchlist, filters, activeTab]);
 
            const sortedData = useMemo(() => {
                let items = [...filteredData];
                if (sortConfig.key) {
                    items.sort((a, b) => {
                        let av = a[sortConfig.key], bv = b[sortConfig.key];
                        if (sortConfig.key.includes('Date')) { av = new Date(av || 0); bv = new Date(bv || 0); }
                        return (av < bv ? -1 : 1) * (sortConfig.direction === 'ascending' ? 1 : -1);
                    });
                }
                return items;
            }, [filteredData, sortConfig]);
 
            const paginatedData = useMemo(() => sortedData.slice((currentPage-1)*ITEMS_PER_PAGE, currentPage*ITEMS_PER_PAGE), [sortedData, currentPage]);
            const totalPages = Math.ceil(sortedData.length / ITEMS_PER_PAGE);
            const { uniqueCounties, chartData } = useMemo(() => {
                const c = new Set(), cc = {}, yc = {};
                filteredData.forEach(i => {
                    if (i.County && i.County !== 'N/A') { c.add(i.County); cc[i.County] = (cc[i.County]||0)+1; }
                    if (i.Date && i.Date !== 'Unknown') { const y = i.Date.substring(0,4); if(!isNaN(y)) yc[y] = (yc[y]||0)+1; }
                });
                return {
                    uniqueCounties: Array.from(c).sort(),
                    chartData: {
                        bar: Object.entries(cc).map(([name,count]) => ({name,count})).sort((a,b)=>b.count-a.count).slice(0,10),
                        line: Object.entries(yc).map(([year,count]) => ({year,count})).sort((a,b)=>a.year.localeCompare(b.year))
                    }
                };
            }, [filteredData]);
 
            const handleSort = (key) => setSortConfig({ key, direction: sortConfig.key===key && sortConfig.direction==='ascending' ? 'descending' : 'ascending' });
            const toggleWatchlist = (r) => setWatchlist(prev => { const n={...prev}; if(n[r._id]) delete n[r._id]; else n[r._id]=r; return n; });
            const resetFilters = () => { setFilters({ global: '', name: '', counties: [], dateFrom: '', dateTo: '' }); setCurrentPage(1); };
            const setQuickDate = (type) => {
                const now = new Date(); let from = new Date();
                if (type === '30d') from.setDate(now.getDate() - 30);
                else if (type === 'ytd') from = new Date(now.getFullYear(), 0, 1);
                else { setFilters(f => ({ ...f, dateFrom: '', dateTo: '' })); return; }
                setFilters(f => ({ ...f, dateFrom: from.toISOString().split('T')[0], dateTo: now.toISOString().split('T')[0] }));
            };
 
            const handleExport = (type) => {
                const timestamp = new Date().toISOString().split('T')[0];
                const fileName = `DNAFL_${activeTab}_${timestamp}.${type}`;
                if (type === 'json') {
                    downloadFile({ data: JSON.stringify(sortedData, null, 2), fileName, fileType: 'application/json' });
                } else {
                    const headers = Object.keys(sortedData[0] || {}).filter(k => !k.startsWith('_'));
                    const csvContent = [headers.join(','), ...sortedData.map(row => headers.map(fieldName => `"${(row[fieldName] || '').replace(/"/g, '""')}"`).join(','))].join('\r\n');
                    downloadFile({ data: csvContent, fileName, fileType: 'text/csv' });
                }
            };
 
            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-900 transition-colors duration-200">
                    <header className="bg-slate-900 dark:bg-slate-950 text-white sticky top-0 z-50 shadow-md">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center space-x-3">
                                <I.AlertTriangle className="text-orange-500 w-8 h-8" />
                                <div><h1 className="text-xl font-bold">DNAFL Dashboard</h1><p className="text-xs text-slate-400 hidden sm:block">Florida Animal Abuser Registry Tracker</p></div>
                            </div>
                            <nav className="hidden md:flex items-center space-x-4">
                                <button onClick={() => setDarkMode(!darkMode)} className="p-2 text-slate-300 hover:text-white hover:bg-slate-800 rounded-full transition-colors" title={`Switch to ${darkMode ? 'light' : 'dark'} mode`}>{darkMode ? <I.Sun className="w-5 h-5" /> : <I.Moon className="w-5 h-5" />}</button>
                                <button onClick={() => setShowWatchlist(!showWatchlist)} className={`flex items-center px-3 py-2 rounded-md text-sm font-medium transition-colors ${showWatchlist?'bg-yellow-500/20 text-yellow-400':'text-slate-300 hover:text-white hover:bg-slate-800'}`}>
                                    <I.Star className={`w-4 h-4 mr-2 ${showWatchlist?'fill-yellow-400':''}`} /> Watchlist ({Object.keys(watchlist).length})
                                </button>
                                <a href="https://github.com/EliteGreyIT67/DNAFL-app" target="_blank" className="text-slate-300 hover:text-white p-2 hover:bg-slate-800 rounded-full transition-colors"><I.ExternalLink className="w-5 h-5" /></a>
                            </nav>
                            <div className="md:hidden flex items-center space-x-2">
                                <button onClick={() => setDarkMode(!darkMode)} className="p-2 text-slate-300">{darkMode ? <I.Sun className="w-6 h-6" /> : <I.Moon className="w-6 h-6" />}</button>
                                <button onClick={() => setShowWatchlist(!showWatchlist)} className="p-2 text-slate-300"><I.Star className={`w-6 h-6 ${showWatchlist?'fill-yellow-400 text-yellow-400':''}`} /></button>
                                <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="p-2 text-slate-300">{mobileMenuOpen?<I.X className="w-6 h-6"/>:<I.Menu className="w-6 h-6"/>}</button>
                            </div>
                        </div>
                    </header>
 
                    <main className="max-w-7xl mx-auto px-4 py-6">
                        {!showWatchlist && <div className="mb-6 overflow-x-auto pb-2 -mx-4 px-4 no-scrollbar"><nav className="flex space-x-2">{REGISTRIES.map(t => <button key={t.id} onClick={()=>setActiveTab(t.id)} className={`whitespace-nowrap px-4 py-2 rounded-full text-sm font-semibold border transition-all ${activeTab===t.id?`bg-${t.color}-100 dark:bg-${t.color}-900/30 text-${t.color}-800 dark:text-${t.color}-300 border-${t.color}-300 dark:border-${t.color}-700`:'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>{t.label}</button>)}</nav></div>}
 
                        {showWatchlist && <div className="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 p-4 mb-6 flex justify-between rounded-r-lg animate-in fade-in"><div className="flex"><I.Star className="h-6 w-6 text-yellow-400 fill-yellow-400 mr-3"/><div><h2 className="text-lg font-bold text-yellow-800 dark:text-yellow-300">Watchlist</h2><p className="text-sm text-yellow-700 dark:text-yellow-400">Locally saved records.</p></div></div><button onClick={()=>setShowWatchlist(false)} className="text-yellow-800 dark:text-yellow-300 hover:bg-yellow-100 dark:hover:bg-yellow-900/40 p-2 rounded-full transition-colors"><I.X className="w-5 h-5"/></button></div>}
 
                        <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 mb-6 space-y-4 transition-colors duration-200">
                            <div className="flex flex-col lg:flex-row gap-4">
                                <div className="relative flex-1"><I.Search className="absolute left-3 top-3 h-5 w-5 text-slate-400"/><input type="text" className="pl-10 pr-4 py-2 w-full border border-slate-300 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-800 text-slate-900 dark:text-white" placeholder="Search all records..." value={filters.global} onChange={e=>{setFilters({...filters,global:e.target.value});setCurrentPage(1)}}/></div>
                                <div className="flex flex-wrap gap-2">
                                    <button onClick={()=>setShowFilters(!showFilters)} className={`btn-secondary ${showFilters?'bg-slate-100 dark:bg-slate-700':''}`}><I.Filter className="w-4 h-4 mr-2"/> Filters {(filters.name||filters.counties.length>0||filters.dateFrom||filters.dateTo)&&<span className="ml-2 w-2 h-2 bg-blue-500 rounded-full"/>}</button>
                                    <button onClick={()=>setShowCharts(!showCharts)} className={`btn-secondary ${showCharts?'bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-800':''}`}>{showCharts?<I.TrendingUp className="w-4 h-4 mr-2"/>:<I.BarChart3 className="w-4 h-4 mr-2"/>} Insights</button>
                                    <div className="relative group">
                                        <button className="btn-secondary"><I.Download className="w-4 h-4 mr-2"/> Export</button>
                                        <div className="absolute right-0 mt-2 w-36 bg-white dark:bg-slate-800 rounded-md shadow-lg border border-slate-200 dark:border-slate-700 hidden group-hover:block z-10">
                                            <button onClick={() => handleExport('csv')} className="block w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">as CSV</button>
                                            <button onClick={() => handleExport('json')} className="block w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">as JSON</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {showFilters && <div className="pt-4 border-t border-slate-100 dark:border-slate-700 animate-in slide-in-from-top-2">
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                    <div><label className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1 block">Name</label><input className="input-field" placeholder="e.g. Smith" value={filters.name} onChange={e=>setFilters({...filters,name:e.target.value})}/></div>
                                    <MultiSelect label="Counties" options={uniqueCounties} selected={filters.counties} onChange={newCounties => setFilters({...filters, counties: newCounties})} />
                                    <div><label className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1 block">From</label><input type="date" className="input-field" value={filters.dateFrom} onChange={e=>setFilters({...filters,dateFrom:e.target.value})}/></div>
                                    <div><label className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1 block">To</label><input type="date" className="input-field" value={filters.dateTo} onChange={e=>setFilters({...filters,dateTo:e.target.value})}/></div>
                                </div>
                                <div className="flex justify-between items-center">
                                    <div className="flex space-x-2 text-xs">
                                        <button onClick={()=>setQuickDate('30d')} className="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">Last 30 Days</button>
                                        <button onClick={()=>setQuickDate('ytd')} className="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">YTD</button>
                                        <button onClick={()=>setQuickDate('all')} className="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">All Time</button>
                                    </div>
                                    <button onClick={resetFilters} className="text-sm text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 flex items-center"><I.Trash2 className="w-4 h-4 mr-1"/> Clear Filters</button>
                                </div>
                            </div>}
                        </div>
 
                        {showCharts && !loading && !error && <div className="mb-6 grid lg:grid-cols-2 gap-6 animate-in fade-in">
                            <div className="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 h-80 transition-colors duration-200"><h3 className="font-semibold mb-4 flex items-center dark:text-slate-100"><I.MapPin className="w-4 h-4 mr-2"/> Top Counties</h3><ResponsiveContainer width="100%" height="90%"><BarChart data={chartData.bar}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" className="dark:stroke-slate-700"/><XAxis dataKey="name" tick={{fontSize:12, fill: darkMode?'#94a3b8':'#64748b'}} stroke={darkMode?'#475569':'#cbd5e1'}/><YAxis tick={{fontSize:12, fill: darkMode?'#94a3b8':'#64748b'}} stroke={darkMode?'#475569':'#cbd5e1'}/><RechartsTooltip contentStyle={{backgroundColor: darkMode?'#1e293b':'#fff', borderColor: darkMode?'#334155':'#e2e8f0', color: darkMode?'#fff':'#0f172a' }}/><Bar dataKey="count" fill="#3b82f6" radius={[4,4,0,0]}/></BarChart></ResponsiveContainer></div>
                            <div className="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 h-80 transition-colors duration-200"><h3 className="font-semibold mb-4 flex items-center dark:text-slate-100"><I.Calendar className="w-4 h-4 mr-2"/> Timeline</h3><ResponsiveContainer width="100%" height="90%"><LineChart data={chartData.line}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" className="dark:stroke-slate-700"/><XAxis dataKey="year" tick={{fontSize:12, fill: darkMode?'#94a3b8':'#64748b'}} stroke={darkMode?'#475569':'#cbd5e1'}/><YAxis tick={{fontSize:12, fill: darkMode?'#94a3b8':'#64748b'}} stroke={darkMode?'#475569':'#cbd5e1'}/><RechartsTooltip contentStyle={{backgroundColor: darkMode?'#1e293b':'#fff', borderColor: darkMode?'#334155':'#e2e8f0', color: darkMode?'#fff':'#0f172a' }}/><Line type="monotone" dataKey="count" stroke="#f97316" strokeWidth={3} dot={{r:4}}/></LineChart></ResponsiveContainer></div>
                        </div>}
 
                        {error ? <div className="bg-red-50 dark:bg-red-900/20 p-6 rounded-lg text-center text-red-800 dark:text-red-300 border border-red-200 dark:border-red-800/50"><I.AlertTriangle className="h-12 w-12 mx-auto mb-4 text-red-500"/>{error}</div> :
                         loading ? <div className="space-y-4 animate-pulse">{[...Array(5)].map((_,i)=><div key={i} className="bg-white dark:bg-slate-800 h-24 rounded-xl border border-slate-100 dark:border-slate-700"/>)}</div> :
                         filteredData.length===0 ? <div className="bg-white dark:bg-slate-800 p-16 rounded-xl text-center border border-slate-200 dark:border-slate-700 transition-colors duration-200"><div className="bg-slate-100 dark:bg-slate-700 p-4 rounded-full inline-block mb-4"><I.Search className="h-12 w-12 text-slate-400 dark:text-slate-500"/></div><h3 className="text-lg font-bold text-slate-900 dark:text-slate-100">No matching records</h3><p className="text-slate-500 dark:text-slate-400 mt-2">Try adjusting or clearing your filters.</p></div> :
                         <>
                            <div className="hidden md:block bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden transition-colors duration-200"><table className="min-w-full divide-y divide-slate-200 dark:divide-slate-700"><thead className="bg-slate-50 dark:bg-slate-900/50"><tr><th className="w-20 px-4 py-3"/><th className="w-12 px-2 py-3"/>{Object.keys(paginatedData[0]||{}).filter(k=>!k.startsWith('_')).map(h=><th key={h} onClick={()=>handleSort(h)} className="px-6 py-3 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors"><div className="flex items-center space-x-1"><span>{h}</span>{sortConfig.key===h && (sortConfig.direction==='ascending'?<I.ChevronUp className="w-3 h-3 text-blue-500"/>:<I.ChevronDown className="w-3 h-3 text-blue-500"/>)}</div></th>)}</tr></thead><tbody className="divide-y divide-slate-200 dark:divide-slate-700">{paginatedData.map(r=><tr key={r._id} className={`hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors ${watchlist[r._id]?'bg-yellow-50/50 dark:bg-yellow-900/10':''}`}><td className="px-4 py-4 text-center"><button onClick={()=>toggleWatchlist(r)}><I.Star className={`w-5 h-5 ${watchlist[r._id]?'fill-yellow-400 text-yellow-400':'text-slate-300 dark:text-slate-600'}`}/></button></td><td className="px-2 py-4 text-center"><CopyButton text={Object.entries(r).filter(([k])=>!k.startsWith('_')).map(([k,v])=>`${k}: ${v}`).join(', ')} /></td>{Object.keys(r).filter(k=>!k.startsWith('_')).map(k=><td key={k} className="px-6 py-4 text-sm whitespace-nowrap max-w-[250px] truncate dark:text-slate-300" title={r[k]}>{renderCellContent(r[k])}</td>)}</tr>)}</tbody></table></div>
                            <div className="md:hidden space-y-4">{paginatedData.map(r=><MobileCard key={r._id} row={r} isWatched={!!watchlist[r._id]} onToggleWatch={()=>toggleWatchlist(r)}/>)}</div>
                            {totalPages>1 && <div className="flex justify-center items-center space-x-4 mt-6"><button onClick={()=>setCurrentPage(p=>Math.max(1,p-1))} disabled={currentPage===1} className="p-2 rounded border bg-white dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300 disabled:opacity-50"><I.ChevronLeft className="w-5 h-5"/></button><span className="text-sm dark:text-slate-300">Page {currentPage} of {totalPages}</span><button onClick={()=>setCurrentPage(p=>Math.min(totalPages,p+1))} disabled={currentPage===totalPages} className="p-2 rounded border bg-white dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300 disabled:opacity-50"><I.ChevronRight className="w-5 h-5"/></button></div>}
                         </>
                        }
                    </main>
                </div>
            );
        }
 
        const MobileCard = ({ row, isWatched, onToggleWatch }) => {
            const [expanded, setExpanded] = useState(false);
            const headers = Object.keys(row).filter(k => !k.startsWith('_'));
            return (
                <div className={`bg-white dark:bg-slate-800 rounded-lg border ${isWatched?'border-yellow-300 dark:border-yellow-500/50 ring-1 ring-yellow-100 dark:ring-yellow-900/30':'border-slate-200 dark:border-slate-700'} transition-colors duration-200`}>
                    <div className="p-4">
                        <div className="flex justify-between items-start mb-3"><div><h3 className="font-bold dark:text-white">{row.Name}</h3>{row.Date && <span className="text-xs flex items-center text-slate-500 dark:text-slate-400 mt-1"><I.Calendar className="w-3 h-3 mr-1"/> {row.Date}</span>}</div><div className="flex space-x-2"><CopyButton text={Object.entries(row).filter(([k])=>!k.startsWith('_')).map(([k,v])=>`${k}: ${v}`).join(', ')} /><button onClick={e=>{e.stopPropagation();onToggleWatch()}}><I.Star className={`w-6 h-6 ${isWatched?'fill-yellow-400 text-yellow-400':'text-slate-300 dark:text-slate-600'}`}/></button></div></div>
                        <div className="space-y-2 text-sm">{headers.slice(0,3).filter(k=>k!=='Name'&&k!=='Date').map(k=><div key={k} className="flex justify-between border-b border-slate-50 dark:border-slate-700 pb-1"><span className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">{k}</span><span className="max-w-[70%] text-right truncate dark:text-slate-300">{renderCellContent(row[k])}</span></div>)}</div>
                    </div>
                    {headers.length>3 && <><div className={`px-4 pb-4 space-y-2 text-sm border-t border-slate-100 dark:border-slate-700 pt-3 bg-slate-50/50 dark:bg-slate-900/30 ${expanded?'block':'hidden'}`}>{headers.slice(3).map(k=><div key={k}><span className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase block mb-1">{k}</span><div className="bg-white dark:bg-slate-800 p-2 rounded border border-slate-100 dark:border-slate-700 break-words dark:text-slate-300">{renderCellContent(row[k])}</div></div>)}</div><button onClick={()=>setExpanded(!expanded)} className="w-full py-2 bg-slate-50 dark:bg-slate-800/50 text-xs font-medium text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700/50 border-t dark:border-slate-700 flex justify-center items-center transition-colors">{expanded?'Less':'More'} {expanded?<I.ChevronUp className="w-3 h-3 ml-1"/>:<I.ChevronDown className="w-3 h-3 ml-1"/>}</button></>}
                </div>
            );
        };
 
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
